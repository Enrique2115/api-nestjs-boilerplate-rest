name: Dependency Analysis

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node âš™ï¸
        uses: ./.github/actions/setup-node

      - name: Install required tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          npm install -g depcheck

      - name: Run dependency analysis
        id: analysis
        run: |
          OUTPUT_FILE="analysis_output.txt"

          {
            echo "ðŸ” Analizando dependencias no utilizadas..."
            echo ""
            echo "ðŸ“Š ANÃLISIS DE DEPENDENCIAS NO UTILIZADAS:"
            echo "=========================================="
            
            # Capturar salida exitosa de depcheck
            depcheck_output=$(depcheck --ignores="lint-staged,eslint-*,nyc,pino-pretty,rimraf,@vitest/coverage-istanbul,@commitlint/*" --json 2>/dev/null)
            depcheck_exit=$?
            
            # Manejar cÃ³digos de salida especÃ­ficos
            if [ $depcheck_exit -eq 0 ] || [ $depcheck_exit -eq 1 ]; then
              # CÃ³digo 0: Ã‰xito sin dependencias no utilizadas
              # CÃ³digo 1: Ã‰xito pero con dependencias no utilizadas (comportamiento normal)
              :
            else
              # Error real, usar JSON vacÃ­o
              depcheck_output='{"dependencies":[],"devDependencies":[]}'
              echo "âš ï¸  Depcheck encontrÃ³ un error (cÃ³digo $depcheck_exit). Usando datos vacÃ­os."
            fi
            
            if command -v jq &> /dev/null; then
              # Procesar JSON vÃ¡lido
              if jq -e . >/dev/null 2>&1 <<<"$depcheck_output"; then
                unused_deps=$(echo "$depcheck_output" | jq -r '
                  if .dependencies? and (.dependencies | length) > 0 then
                    "âŒ DEPENDENCIAS NO USADAS:",
                    (.dependencies[] | "  - " + .)
                  else
                    "âœ… Todas las dependencias estÃ¡n siendo utilizadas"
                  end')
                
                unused_dev_deps=$(echo "$depcheck_output" | jq -r '
                  if .devDependencies? and (.devDependencies | length) > 0 then
                    "âŒ DEPENDENCIAS DE DESARROLLO NO USADAS:",
                    (.devDependencies[] | "  - " + .)
                  else
                    "âœ… Todas las dependencias de desarrollo estÃ¡n siendo utilizadas"
                  end')
                
                echo "$unused_deps"
                echo ""
                echo "$unused_dev_deps"
              else
                echo "âš ï¸  Salida JSON invÃ¡lida de depcheck"
                echo "âœ… Todas las dependencias estÃ¡n siendo utilizadas"
                echo "âœ… Todas las dependencias de desarrollo estÃ¡n siendo utilizadas"
              fi
            else
              echo "âš ï¸  jq no estÃ¡ instalado. Mostrando salida simplificada..."
              echo "Instala jq para ver un anÃ¡lisis mÃ¡s detallado: https://stedolan.github.io/jq/download/"
              echo ""
              depcheck
            fi

            echo ""
            echo "ðŸ“ˆ TAMAÃ‘O DE NODE_MODULES:"
            echo "========================="
            du -sh node_modules 2>/dev/null || echo "node_modules no encontrado"

            echo ""
            echo "ðŸ“¦ TOP 10 PAQUETES MÃS PESADOS:"
            echo "==============================="
            du -sh node_modules/*/ 2>/dev/null | sort -hr | head -10

            echo ""
            echo "ðŸ§¹ RECOMENDACIONES:"
            echo "=================="
            echo "1. Revisa las dependencias marcadas como no utilizadas"
            echo "2. Mueve dependencias de build a devDependencies"
            echo "3. Considera alternativas mÃ¡s ligeras para paquetes pesados"
            echo "4. Usa pnpm prune regularmente"
          } > "$OUTPUT_FILE"

          cat "$OUTPUT_FILE"

          {
            echo "ANALYSIS_OUTPUT<<EOF"
            cat "$OUTPUT_FILE"
            echo "EOF"
          } >> "$GITHUB_ENV"

      - name: Create sticky comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: dependency-analysis
          message: |
            ${{ env.ANALYSIS_OUTPUT }}
